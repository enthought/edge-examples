# Externally-Hosted App Example

This folder contains a Flask + React application that showcases how to
integrate an external web app with Edge, by using JupyterHub as the OAuth2 provider.

## Understanding the OAuth 2.0 flow
    
A single OAuth2 flow generally goes like this:

* A user makes an HTTP request to access your application, i.e. the *OAuth2 client*.
* The user is not logged in, so the client redirects the user to an "authorize" 
  endpoint on the *OAuth2 provider*, with some extra information:
    - the *client id* of your application
    - the *client secret* associated with your application
    - the *redirect uri* on your application to be redirected back to after completion
* The user is prompted to sign in on the OAuth2 provider's page
* After the user is authenticated with the provider, a short-lived record
  called an OAuth2 code is generated by the provider and the user is redirected
  to the OAuth2 client's "redirect uri" with the OAuth code.
* The OAuth2 client receives the code and makes an API request to the provider
  to exchange the code for a real *access token*.
* Once the token is retrieved, the client makes a second API request to the
  provider to retrieve information about the owner of the token (the user).
* Finally, the OAuth2 client stores its own record that the user is authorized
  in a cookie.

In the context of an External Edge Application:
- The **OAuth2 client** is your application
- The **OAuth2 provider** is Edge
- The **client id** and **client secret** are obtained when registering your
  application as an external Edge application.
- The **redirect uri** is an endpoint on your application that handles the
  exchange of an OAuth2 code for an access token.

## Pre-requisites

To build and run the example application you will need EDM, Docker and `npm`
installed and available in your PATH.

You will also need to have the Edge stack running alongside JupyterHub. To get
started, run the below commands while at the root of the Edge project directory:

* Build Docker images: ``python -m ci docker build``
* Start JupyterHub: ``python -m ci jupyter start``
* Launch the stack: ``python -m ci stack up``

## Running the Application

If you are running the application for the first time, you will need to build
the application's Docker image. From within the `external-app-example` directory
run:

```commandline
    python -m ci build
```

Once built, start the application with:

```commandline
    python -m ci start
```

## Deploying the Application

If it's your first time deploying the application, make sure you follow the
steps below as they describe how to install and configure `kubectl` and
the `terraform` CLI:

1. Request that Product DevOps add your username to the `edge-dev` namespace
   module
2. Ask Product DevOps for a kube config file. Configurations are stored in the
   Product DevOps Vault.
3. Install `kubectl`
```bash
brew install kubectl
brew link --overwrite kubernetes-cli # if you have Docker Desktop installed
```
4. Install the [kubelogin](https://github.com/int128/kubelogin) plugin
```bash
brew install int128/kubelogin/kubelogin
```
5. Replace your `~/.kube/config` file with one from Product DevOps
6. Switch to the namespace to `edge-dev`
```bash
kubectl config set-context --current --namespace=edge-dev
```
7. Test your configuration
```bash
kubectl get pods
```
8. [Install](https://learn.hashicorp.com/tutorials/terraform/install-cli) `terraform`

Once you've met the pre-requisites listed above, you may continue with the
deployment of the application.

First, `cd` to the `deploy` directory.

If it's your first time deploying the demo application from your environment,
run:
```bash
terraform init
```

To *deploy* the demo application, run:
```bash
terraform apply
```

To check that your deployment succeded you can run `kubectl describe pod` or 
`kubectl describe deploy`.

You can open the demo app in your browser by going to https://edge-dev.platform-devops.enthought.com/

If you make changes to the deployment files, and you would like to preview
those changes before deploying, run:
```bash
terraform plan
```

Note that both `apply` and `plan` will prompt you for various secrets, those
can be found in the project secrets doc in the project's shared drive. If you
are unsure where that is located, or don't have access to the shared drive,
reach out to the project's Team Lead.

If you make changes to the application and would like to see those changes
reflected in the deployment, build and publish your Docker image
using `python -m ci build` and `python -m ci publish`, and restart your
deployment with:

```bash
kubectl rollout restart deploy edge-example-app
```

Finally, to *teardown* the deployment, run:
```bash
terraform destroy
```

If you have any questions about the above instructions or issues with the
deployment reach out to Product DevOps for assistance.
